/*!
 * duckfficer v1.1.0
 * (c) 2019-2020 Martin Rafael <tin@devtin.io>
 * MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("events")):"function"==typeof define&&define.amd?define(["exports","events"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).default=t.default||{},t.events)}(this,(function(t,e){"use strict";function r(t){return Array.isArray(t)?t:[t]}function s(t,{parent:e="",separator:r="."}={}){const i=[];return Object.keys(t).forEach(a=>{if(t[a]&&"object"==typeof t[a]&&!Array.isArray(t[a]))return i.push(...s(t[a],{parent:`${e}${a}${r}`,separator:r}));i.push(`${e}${a}`)}),i}function i(t,e){const[r,...s]=Array.isArray(e)?e:e.split(".");return s.length>0&&"object"==typeof t[r]?i(t[r],s):r?t[r]:t}function a(t,e){for(let r=0;r<t.length&&!1!==e(t[r],r);r++);}function n(t){return t.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")}function o(t,e){return s(e).forEach(r=>{t=t.replace(new RegExp(`{[\\s]*${r.split(".").map(n).join(".")}[\\s]*}`,"g"),i(e,r))}),t}function h(t){return"object"==typeof t&&!Array.isArray(t)&&null!==t}function l(t,e,{strict:r=!1}={}){if(!h(t))return!1;let s=!0;return r&&a(e,i=>{if(i.indexOf(".")>0){const[a]=i.split(".");return s=l(t[a],function(t,e){e=e.split(".").map(n).join(".");const r=new RegExp(`^${e}\\.`);return t.filter(t=>r.test(t)).map(t=>t.replace(r,""))}(e,a),{strict:r}),s}if(!Object.prototype.hasOwnProperty.call(t,i))return s=!1,s}),s&&a(Object.keys(t),r=>{if("object"==typeof t[r]&&!Array.isArray(t[r])){const i=new RegExp(`^${n(r)}\\.(.+)$`);let a=e.indexOf(r)>=0;const o=e.filter(t=>i.test(t)).map(t=>(a=!1,t.replace(i,"$1")));return s=a||l(t[r],o),s}if(-1===e.indexOf(r))return s=!1,s}),s}var c=Object.freeze({__proto__:null,castArray:r,obj2dot:s,find:i,forEach:a,render:o,propertiesRestricted:l});function u(t,e){return Array.isArray(t)&&2===t.length?t:[t,e]}const p={Array:{settings:{typeError:"Invalid array"},parse(t){return this.settings.arraySchema&&(t=t.map((t,e)=>{const r=this.constructor.castSchema(this.settings.arraySchema);return("Schema"===this.constructor.guessType(r)?this.constructor.cloneSchema({schema:r,name:e,parent:this,settings:r.settings}):new this.constructor(this.settings.arraySchema,Object.assign({},this.settings.arraySchema,{name:e,parent:this}))).parse(t)})),t},validate(t){Array.isArray(t)||this.throwError(this.settings.typeError,{value:t})}},BigInt:{settings:{typeError:"Invalid bigint",autoCast:!1},validate(t){"bigint"!=typeof t&&this.throwError(this.settings.typeError)},cast(t){if(/^(string|number)$/.test(typeof t))try{t=BigInt(t)}catch(t){}return t}},Boolean:{settings:{typeError:"Invalid boolean",autoCast:!1},cast:t=>!!t,validate(t){"boolean"!=typeof t&&this.throwError(this.settings.typeError,{value:t})}},Date:{settings:{typeError:"Invalid date",autoCast:!0},cast(t){if(t instanceof Date)return t;const e=new Date(Number.isInteger(t)?t:Date.parse(t));return"Invalid Date"!==e.toString()&&(t=e),t},validate(t){t instanceof Date||this.throwError(this.settings.typeError,{value:t})}},Function:{settings:{typeError:"Invalid function"},validate(t){"function"!=typeof t&&this.throwError(this.settings.typeError,{value:t})}},Map:{settings:{typeError:"Invalid map",autoCast:!0},cast:t=>(!h(t)||t instanceof Map||(t=new Map(Object.entries(t))),t),validate(t){t instanceof Map||this.throwError(this.settings.typeError,{value:t})}},Number:{settings:{typeError:"Invalid number",minError:"minimum accepted value is { value }",maxError:"maximum accepted value is { value }",integerError:"Invalid integer",min:void 0,max:void 0,integer:!1,decimalPlaces:void 0,autoCast:!1},cast:t=>Number(t),validate(t){("number"!=typeof t||isNaN(t))&&this.throwError(this.settings.typeError,{value:t}),this.settings.integer&&!Number.isInteger(t)&&this.throwError(this.settings.integerError,{value:t}),void 0!==this.settings.min&&t<this.settings.min&&this.throwError(this.settings.minError,{value:this.settings.min}),void 0!==this.settings.max&&t>this.settings.max&&this.throwError(this.settings.maxError,{value:this.settings.max})},parse(t){if(void 0!==this.settings.decimalPlaces){const e=Math.pow(10,this.settings.decimalPlaces);return Math.round(t*e)/e}return t}},Object:{settings:{typeError:"Invalid object"},parse(t){return void 0!==this.settings.mapSchema&&Object.keys(t).forEach(e=>{const r=t[e],s=this.constructor.castSchema(this.settings.mapSchema),i="Schema"===this.constructor.guessType(s)?this.constructor.cloneSchema({schema:s,name:e,settings:s.settings,parent:this}):t[e]=new this.constructor(this.settings.mapSchema,Object.assign({},this.settings.mapSchema,{name:e,parent:this}));t[e]=i.parse(r)}),t},validate(t){h(t)||this.throwError(this.settings.typeError,{value:t})}},Promise:{settings:{typeError:"Invalid Promise",autoCast:!1,isPromise:t=>h(t)&&"function"==typeof t.then},cast:t=>p.Promise.settings.isPromise(t)?t:"function"==typeof t?Promise.resolve(t()):Promise.resolve(t),validate(t){p.Promise.settings.isPromise(t)||this.throwError(this.settings.typeError,{value:t})}},Set:{settings:{typeError:"Invalid set",autoCast:!0},cast:t=>(Array.isArray(t)&&(t=new Set(t)),t),validate(t){t instanceof Set||this.throwError(this.settings.typeError,{value:t})}},String:{settings:{typeError:"Invalid string",enumError:"Unknown enum option { value }",enum:[],autoCast:!1,lowercase:!1,uppercase:!1},cast:t=>(t&&Object.hasOwnProperty.call(t,"toString")&&"function"==typeof t.toString&&"[object Object]"!==t.toString()&&(t=t.toString()),t),validate(t){if("string"!=typeof t&&this.throwError(this.settings.typeError,{value:t}),Array.isArray(this.settings.enum)&&this.settings.enum.length>0&&this.settings.enum.indexOf(t)<0&&this.throwError(this.settings.enumError,{value:t}),this.settings.minlength){const[e,r]=u(this.settings.minlength,"Invalid minlength");t.length<e&&this.throwError(r,{value:t})}if(this.settings.maxlength){const[e,r]=u(this.settings.maxlength,"Invalid maxlength");t.length>e&&this.throwError(r,{value:t})}if(this.settings.regex){const[e,r]=u(this.settings.regex,"Invalid regex");e.test(t)||this.throwError(r,{value:t})}},parse(t){return this.settings.lowercase&&(t=t.toLowerCase()),this.settings.uppercase&&(t=t.toUpperCase()),t}}};class d extends Error{constructor(t,{errors:e=[],value:r,field:s}){super(o(t,{errors:e,value:r,field:s})),this.errors=e,this.value=r,this.field=s}toJSON(){const{message:t,value:e}=this,r={message:t,value:e};return this.field&&Object.assign(r,{field:this.field.fullPath}),r}}class g extends Error{constructor(t,e){super(t),this.errorName=t,this.payload=e}}const f=t=>t;class m{constructor(t,{name:e,defaultValues:s={},methods:i={},parent:a,validate:n,cast:o,settings:h={}}={}){if(this._settings=h,Array.isArray(t)&&1===t.length&&(t=t[0]),this._methods=i,this.schema=t,this.parent=a,this._validate=n,this._cast=o,this.name=e||"",this.originalName=this.name,this.type=m.guessType(t),this.currentType=r(this.type)[0],this.children=[],this._defaultSettings={required:!0,allowNull:!1,default:void 0},this._defaultValues=s,this.virtuals=[],m.isNested(t)?this.children=this._parseSchema(t):(this._settings="object"==typeof t?Object.assign({},this._settings,{required:void 0===t.default},t):this._settings,delete this._settings.type),void 0!==this.settings.default&&this.settings.required)throw new Error(`Remove either the 'required' or the 'default' option for property ${this.fullPath}.`);this._defaultSettings.default=this.getDefault()}get hasChildren(){return this.children.length>0}get validate(){return this._validate||f}get cast(){return this._cast||f}get settings(){return!this.hasChildren&&p[this.currentType]&&p[this.currentType].settings?Object.assign(this._defaultSettings,p[this.currentType].settings,this._settings):Object.assign(this._defaultSettings,this._settings)}static castSchema(t){return t instanceof m?t:"object"==typeof t&&"Schema"===m.guessType(t.type)?t.type:t}static castSettings(t){if(t instanceof m)return t.settings;const e=Object.assign({},t);return delete e.type,e}isValid(t){try{return this.parse(t),!0}catch(t){return!1}}_parseSchema(t){return Object.keys(t).map(e=>{const r=Object.getOwnPropertyDescriptor(t,e);if("function"!=typeof r.get&&"function"!=typeof r.set)return"Schema"===m.guessType(t[e])?m.cloneSchema({schema:m.castSchema(t[e]),settings:m.castSettings(t[e]),name:e,parent:this}):new m(t[e],{name:e,parent:this});this.virtuals.push({path:e,getter:r.get,setter:r.set})}).filter(Boolean)}static isNested(t){return"Object"===m.guessType(t)&&!t.type}static guessType(t){return t instanceof m?"Schema":"function"==typeof t?t.name:"object"==typeof t&&t.type?m.guessType(t.type):"object"!=typeof t||Array.isArray(t)?(Array.isArray(t)&&(t=t.map(m.guessType)),t):"Object"}get fullPath(){return(this.parent&&this.parent.fullPath?this.parent.fullPath+".":"")+this.name}get ownPaths(){return this.children.map(({name:t})=>t)}get paths(){const t=[];return this.name&&t.push(this.name),this.hasChildren&&this.children.forEach(({paths:e})=>{e.forEach(e=>{t.push((this.name?this.name+".":"")+e)})}),t}static cloneSchema({schema:t,name:e,parent:r,settings:s={},defaultValues:i,type:a,cast:n,validate:o,currentType:h}){const l=Object.assign(Object.create(Object.getPrototypeOf(t)),t,{name:e||t.name,type:a||t.type,currentType:h||t.currentType,_cast:n||!1===n?n:t._cast,_validate:o||!1===o?o:t._validate,parent:r,cloned:!0,_defaultValues:i||t._defaulValues,_settings:Object.assign({},t._settings,s)});return l.children&&(l.children=l.children.map(t=>m.cloneSchema({schema:t,parent:l}))),l}schemaAtPath(t){const[e,r]=t.split(/\./);let s;return a(this.children,t=>{if(t.name===e)return s=t,!1}),r?s.schemaAtPath(r):s}hasField(t,e=!1){return this.paths.indexOf(e?t:t.replace(/\..*$/,""))>=0}structureValidation(t){if(!h(t)||!this.hasChildren)return;const e=[];if(l(t,this.ownPaths)||t&&s(t).forEach(t=>{this.hasChildren&&!this.hasField(t)&&e.push(new Error(`Unknown property ${this.name?this.name+".":""}${t}`))}),this.ownPaths.forEach(r=>{try{this.schemaAtPath(r).structureValidation(t[r])}catch(t){const{errors:r}=t;e.push(...r)}}),e.length>0)throw new d("Invalid object schema"+(this.parent?" in property "+this.fullPath:""),{errors:e,value:t,field:this})}fullCast(t,{state:e}){return"object"==typeof(t=this.cast(t,{state:e}))&&t&&this.hasChildren&&this.children.forEach(r=>{void 0!==r.fullCast(t[r.name],{state:e})&&(t[r.name]=r.fullCast(t[r.name],{state:e}))}),t}static ensureSchema(t){return t instanceof m?t:new m(t)}parse(t,{state:r={}}={}){if(t=this.fullCast(t,{state:r}),this.parent||this.structureValidation(t),t=this.hasChildren?this.runChildren(t,{state:r}):this.parseProperty(this.type,t,{state:r}),this.validate(t,{state:r}),h(t)&&this.virtuals.forEach(({path:e,getter:r,setter:s})=>{Object.defineProperties(t,{[e]:{get:r,set:s,enumerable:!0}})}),h(t)||Array.isArray(t)){const r=new e.EventEmitter;Object.defineProperties(t,{$on:{value:r.on.bind(r),writable:!0,enumerable:!1}}),Object.keys(this._methods).forEach(e=>{const s=this._methods[e].input,i=this._methods[e].output,a=this._methods[e].enumerable,n=this._methods[e].events,o=this._methods[e].errors;Object.defineProperty(t,e,{value:(...a)=>{if(s)try{a=m.ensureSchema(s).parse(1===a.length?a[0]:a)}catch(t){throw new d("Invalid input at method "+e,{errors:t.errors.length>0?t.errors:[t]})}const h={$emit(t,e){if(n){if(!n[t])throw new Error("Unknown event "+t);try{e=m.ensureSchema(n[t]).parse(e)}catch(e){throw new d("Invalid payload for event "+t,{errors:e.errors.length>0?e.errors:[e]})}}r.emit(t,e)},$throw(t,e){if(o){if(!o[t])throw new g("Unknown error "+t);try{e=o[t]?m.ensureSchema(o[t]).parse(e):e}catch(e){throw new d("Invalid payload for error "+t,{errors:e.errors.length>0?e.errors:[e]})}}throw new g(t,e)},$field:t},l=(this._methods[e].handler||this._methods[e]).apply(h,a.length>1?[a]:a);if(i)try{return m.ensureSchema(i).parse(l)}catch(t){throw new d("Invalid output at method "+e,{errors:t.errors.length>0?t.errors:[t]})}return l},writable:!0,enumerable:a})})}return t}processLoaders(t,{loaders:e,state:s}){return a(r(e),e=>{"object"!=typeof e&&(e={type:e});const r=m.guessType(e),i=m.cloneSchema({schema:this,type:r,currentType:r,cast:!1,validate:!1});"Schema"!==r&&(i._settings=Object.assign({},i._settings,e,{loaders:void 0,cast:void 0,validate:void 0})),t=i.parseProperty(r,t,{state:s})}),t}parseProperty(t,e,{state:r={}}={}){if(null===e&&this.settings.allowNull)return e;if(Array.isArray(t)){let s,i=!1;return a(t,t=>{try{return this.currentType=t,s=this.parseProperty(t,e,{state:r}),i=!0,!1}catch(t){}}),i||this.throwError(`Could not resolve given value type${this.fullPath?" in property "+this.fullPath:""}. Allowed types are ${t.slice(0,-1).join(", ")+" and "+t.pop()}`,{value:e}),s}const s=p[t];if(s||this.throwError(`Don't know how to resolve ${t} in property ${this.fullPath}`,{value:e}),void 0!==this.settings.default&&void 0===e&&(e="function"==typeof this.settings.default?this.settings.default.call(this,{state:r}):this.settings.default),void 0!==e||this.settings.required){if(void 0===e&&this.settings.required){const[t,r]=u(this.settings.required,`Property ${this.fullPath} is required`);t&&this.throwError(r,{value:e})}return this.settings.loaders&&(e=this.processLoaders(e,{loaders:this.settings.loaders,state:r})),s.loaders&&(e=this.processLoaders(e,{loaders:s.loaders,state:r})),e=this.runTransformer({method:"cast",transformer:this.settings,payload:e,state:r}),this.settings.autoCast&&(e=this.runTransformer({method:"cast",transformer:s,payload:e,state:r})),this.runTransformer({method:"validate",transformer:s,payload:e,state:r}),this.runTransformer({method:"validate",transformer:this.settings,payload:e,state:r}),this.runTransformer({method:"parse",transformer:s,payload:e,state:r})}}runChildren(t,{method:e="parse",state:r={}}={}){if(!this.settings.required&&void 0===t)return;const s={},i=[];if(this.ownPaths.forEach(a=>{const n=this.schemaAtPath(a.replace(/\..*$/)),o=h(t)?t[n.name]:void 0;(t=>{try{t()}catch(t){t instanceof d&&t instanceof d&&t.errors.length>0?i.push(...t.errors):i.push(t)}})(()=>{const t=n[e](o,{state:r});void 0!==t&&Object.assign(s,{[n.name]:t})})}),i.length>0)throw new d("Data is not valid",{errors:i});return s}runTransformer({method:t,transformer:e,payload:r,state:s}){return e[t]?e[t].call(this,r,{state:s}):r}throwError(t,{errors:e,value:r}={}){throw new d(t,{errors:e,value:r,field:this})}getDefault(t){return this.parent?this.parent.getDefault(t?`${this.name}.${t}`:this.name):t?i(this._defaultValues,t):void 0}}t.Schema=m,t.Transformers=p,t.Utils=c,t.ValidationError=d,Object.defineProperty(t,"__esModule",{value:!0})}));
